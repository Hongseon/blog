---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const baseUrl = import.meta.env.BASE_URL;
const allPosts = (await getCollection('blog'))
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// 태그와 카테고리 수집
const allTags = new Set<string>();
const allCategories = new Set<string>();

allPosts.forEach((post) => {
	post.data.tags.forEach((tag) => allTags.add(tag));
	allCategories.add(post.data.category);
});

// 월별로 그룹화
const postsByMonth = new Map<string, typeof allPosts>();
allPosts.forEach((post) => {
	const monthKey = post.data.pubDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
	if (!postsByMonth.has(monthKey)) {
		postsByMonth.set(monthKey, []);
	}
	postsByMonth.get(monthKey)!.push(post);
});

const sortedMonths = Array.from(postsByMonth.keys()).sort((a, b) => {
	const dateA = new Date(a);
	const dateB = new Date(b);
	return dateB.getTime() - dateA.getTime();
});
---

<BaseLayout title="Blog - My Blog" description="블로그 포스트 목록입니다.">
	<div class="space-y-8">
		<div class="text-center mb-12">
			<h1 class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
				Blog
			</h1>
			<p class="text-slate-600 dark:text-slate-400">
				총 {allPosts.length}개의 포스트
			</p>
		</div>

		<div class="grid lg:grid-cols-4 gap-8">
			<!-- 사이드바: 태그 및 카테고리 -->
			<aside class="lg:col-span-1">
				<div class="sticky top-24 space-y-6">
					<!-- 카테고리 -->
					<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6 border border-slate-200 dark:border-slate-700">
						<h2 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-200">카테고리</h2>
						<ul class="space-y-2">
							{Array.from(allCategories).map((category) => {
								const count = allPosts.filter((p) => p.data.category === category).length;
								return (
									<li>
										<a 
											href={`${baseUrl}blog/category/${category}`}
											class="flex items-center justify-between text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
										>
											<span>{category}</span>
											<span class="text-sm bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">
												{count}
											</span>
										</a>
									</li>
								);
							})}
						</ul>
					</div>

					<!-- 태그 -->
					<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6 border border-slate-200 dark:border-slate-700">
						<h2 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-200">태그</h2>
						<div class="flex flex-wrap gap-2">
							{Array.from(allTags).map((tag) => {
								const count = allPosts.filter((p) => p.data.tags.includes(tag)).length;
								return (
									<a 
										href={`${baseUrl}blog/tag/${tag}`}
										class="text-sm px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
									>
										#{tag} ({count})
									</a>
								);
							})}
						</div>
					</div>
				</div>
			</aside>

			<!-- 메인 콘텐츠: 월별 포스트 -->
			<div class="lg:col-span-3 space-y-8">
				{sortedMonths.map((month) => {
					const posts = postsByMonth.get(month)!;
					return (
						<section>
							<h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-slate-200 border-b border-slate-200 dark:border-slate-700 pb-2">
								{month}
							</h2>
							<div class="space-y-4">
								{posts.map((post) => (
									<article class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6 border border-slate-200 dark:border-slate-700 hover:shadow-xl transition-all duration-300">
										<a href={`${baseUrl}blog/${post.slug}`} class="block">
											<div class="flex items-center gap-3 mb-3">
												<span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full">
													{post.data.category}
												</span>
												<time class="text-sm text-slate-500 dark:text-slate-400">
													{post.data.pubDate.toLocaleDateString('ko-KR')}
												</time>
											</div>
											<h3 class="text-xl font-semibold mb-2 text-slate-800 dark:text-slate-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
												{post.data.title}
											</h3>
											{post.data.description && (
												<p class="text-slate-600 dark:text-slate-400 mb-3 line-clamp-2">
													{post.data.description}
												</p>
											)}
											{post.data.tags.length > 0 && (
												<div class="flex flex-wrap gap-2">
													{post.data.tags.map((tag) => (
														<span class="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded">
															#{tag}
														</span>
													))}
												</div>
											)}
										</a>
									</article>
								))}
							</div>
						</section>
					);
				})}

				{allPosts.length === 0 && (
					<div class="text-center py-12">
						<p class="text-slate-500 dark:text-slate-400">
							아직 작성된 포스트가 없습니다.
						</p>
					</div>
				)}
			</div>
		</div>
	</div>
</BaseLayout>

